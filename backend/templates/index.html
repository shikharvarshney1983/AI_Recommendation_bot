<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Level Analyzer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Icon Definitions ---
        const createIcon = (path, size = 24) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>);
        const icons = {
            helpCircle: createIcon(<><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></>, 14),
            trendingUp: createIcon(<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></>),
            trendingDown: createIcon(<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>),
            chevronsRight: createIcon(<><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></>),
            barChart2: createIcon(<><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>, 20),
            zap: createIcon(<><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></>, 20),
            shield: createIcon(<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></>, 20),
            arrowUp: createIcon(<><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></>, 20),
            activity: createIcon(<><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></>, 48),
            arrowsUpDown: createIcon(<><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></>, 20),
            newspaper: createIcon(<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h4v18H4Z M18 9h-6V7h6v2Z M18 13h-6v-2h6v2Z M18 17h-6v-2h6v2Z"/>, 20)
        };

        // --- Reusable Components ---
        const Tooltip = ({ text, children }) => {
            const [isVisible, setVisible] = React.useState(false);
            return (
                <div className="relative flex items-center" onMouseEnter={() => setVisible(true)} onMouseLeave={() => setVisible(false)}>
                    {children}
                    {isVisible && <div className="absolute left-full ml-2 w-48 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg z-10">{text}</div>}
                </div>
            );
        };

        const Indicator = ({ icon, label, value, unit = '', tooltipText, valueClassName = 'text-white' }) => (
            <div className="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                <div className="flex items-center"><div className="text-gray-400">{icon}</div><span className="ml-3 text-sm font-medium text-gray-300">{label}</span><Tooltip text={tooltipText}><div className="ml-1 text-gray-500 cursor-help">{icons.helpCircle}</div></Tooltip></div>
                <span className={`text-sm font-semibold ${valueClassName}`}>{value} {unit}</span>
            </div>
        );

        const RecommendationCard = ({ recommendation, reason }) => {
            const styles = { Buy: { bg: "bg-green-500/10", border: "border-green-500", text: "text-green-400", icon: icons.trendingUp }, Sell: { bg: "bg-red-500/10", border: "border-red-500", text: "text-red-400", icon: icons.trendingDown }, Hold: { bg: "bg-yellow-500/10", border: "border-yellow-500", text: "text-yellow-400", icon: icons.chevronsRight }};
            const style = styles[recommendation] || styles.Hold;
            return (
                <div className={`p-6 rounded-xl border ${style.border} ${style.bg} shadow-lg`}><div className="flex items-center"><div className={`p-2 rounded-full ${style.bg} ${style.text}`}>{style.icon}</div><h2 className={`ml-4 text-2xl font-bold ${style.text}`}>{recommendation}</h2></div><p className="mt-4 text-gray-300">{reason}</p></div>
            );
        };
        
        const MovingAveragesCard = ({ data }) => {
            const periods = [21, 50, 100, 200];
            return (
                <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
                    <h3 className="text-xl font-bold mb-4 text-gray-200">Moving Averages</h3>
                    <div className="space-y-2 text-sm">
                        <div className="grid grid-cols-3 text-xs text-gray-400 font-bold px-2"><span>Period</span><span className="text-center">EMA</span><span className="text-center">SMA</span></div>
                        {periods.map(p => {
                            const ema = data[`ema${p}`], sma = data[`sma${p}`];
                            if (!ema && !sma) return null;
                            const isAboveEma = data.currentPrice > ema, isAboveSma = data.currentPrice > sma;
                            return (<div key={p} className="grid grid-cols-3 items-center bg-gray-800 p-2 rounded-md"><span className="font-bold text-white">{p}-period</span><span className={`text-center font-semibold ${isAboveEma ? 'text-green-400' : 'text-red-400'}`}>₹{ema.toFixed(2)}</span><span className={`text-center font-semibold ${isAboveSma ? 'text-green-400' : 'text-red-400'}`}>₹{sma.toFixed(2)}</span></div>);
                        })}
                    </div>
                </div>
            );
        };

        const FundamentalsCard = ({ data }) => {
            const formatValue = (value, toFixed = 2, prefix = '') => (value === null || typeof value === 'undefined') ? 'N/A' : `${prefix}${typeof value === 'number' ? value.toFixed(toFixed) : value}`;
            return (
                <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
                    <h3 className="text-xl font-bold mb-4 text-gray-200">Fundamentals & Valuation</h3>
                    <div className="space-y-4">
                        <div><h4 className="text-sm font-semibold text-gray-400 mb-3 px-1">Valuation Metrics</h4><div className="space-y-2"><Indicator icon={icons.barChart2} label="PE Ratio" value={formatValue(data.pe)} tooltipText="Price-to-Earnings Ratio."/><Indicator icon={icons.barChart2} label="Forward PE" value={formatValue(data.forwardPE)} tooltipText="P/E ratio using forecasted earnings."/><Indicator icon={icons.barChart2} label="Price/Book" value={formatValue(data.priceToBook)} tooltipText="Price-to-Book ratio."/></div></div>
                        <div><h4 className="text-sm font-semibold text-gray-400 mb-3 px-1">Fundamental Ratios</h4><div className="space-y-2"><Indicator icon={icons.trendingUp} label="EPS" value={formatValue(data.eps, 2, '₹')} tooltipText="Earnings Per Share."/><Indicator icon={icons.trendingUp} label="Forward EPS" value={formatValue(data.forwardEPS, 2, '₹')} tooltipText="Forecasted Earnings Per Share."/><Indicator icon={icons.chevronsRight} label="CFO / PAT" value={formatValue(data.cfoPat)} tooltipText="Cash Flow from Operations to Profit After Tax."/><Indicator icon={icons.shield} label="Interest Coverage" value={formatValue(data.interestCoverage)} tooltipText="Measures ability to cover interest payments."/></div></div>
                    </div>
                </div>
            );
        };

        // --- NEW: News Analysis Card ---
        const NewsAnalysisCard = ({ news }) => {
            const getSentimentStyle = (sentiment) => {
                const s = sentiment.toLowerCase();
                if (s === 'positive') return 'bg-green-500/20 text-green-400';
                if (s === 'negative') return 'bg-red-500/20 text-red-400';
                return 'bg-gray-600/20 text-gray-400';
            };

            if (!news || news.length === 0 || news[0].error) {
                return (
                    <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700 text-center">
                        <h3 className="text-xl font-bold mb-2 text-gray-200">News Analysis</h3>
                        <p className="text-gray-500">No news available to analyze.</p>
                    </div>
                );
            }

            return (
                <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
                    <div className="flex items-center mb-4"><div className="text-gray-400">{icons.newspaper}</div><h3 className="text-xl font-bold ml-3 text-gray-200">Latest News & Sentiment</h3></div>
                    <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                        {news.map((item, index) => (
                            <div key={index} className="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="font-semibold text-white hover:text-green-400 transition-colors">{item.title}</a>
                                <p className="text-xs text-gray-400 mt-1 mb-2">{item.publisher}</p>
                                <div className="flex items-center justify-between text-xs">
                                    <Tooltip text={item.interpretation}><span className="text-gray-500 cursor-help">Why?</span></Tooltip>
                                    <span className={`px-2 py-1 rounded-full font-medium ${getSentimentStyle(item.sentiment)}`}>{item.sentiment}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [ticker, setTicker] = React.useState('RELIANCE.NS');
            const [timeframe, setTimeframe] = React.useState('daily');
            const [stockData, setStockData] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [initialLoad, setInitialLoad] = React.useState(true);

            const analyzeStock = async () => {
                if (!ticker) { setError("Please enter a stock ticker."); return; }
                setLoading(true); setError(null); setStockData(null);
                if (initialLoad) setInitialLoad(false);
                try {
                    const response = await fetch(`/analyze/${ticker.toUpperCase()}/${timeframe}`);
                    if (!response.ok) throw new Error(`Backend server error: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    setStockData(data);
                } catch (err) {
                    setError(`Failed to analyze stock. ${err.message}. Ensure backend is running.`);
                } finally {
                    setLoading(false);
                }
            };

            const handleFormSubmit = (e) => { e.preventDefault(); analyzeStock(); };
            React.useEffect(() => { if (!initialLoad) analyzeStock(); }, [timeframe]);

            return (
                <div className="bg-gray-900 text-white min-h-screen p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="text-center mb-8">
                            <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">Stock Level Analyzer</h1>
                            <p className="text-gray-400 mt-2">Get technical, fundamental, and news sentiment analysis for any NSE stock.</p>
                        </header>

                        <main>
                            <div className="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-2xl border border-gray-700">
                                <div className="flex justify-center gap-2 mb-6">
                                    {['daily', 'weekly', 'monthly'].map(tf => (<button key={tf} onClick={() => setTimeframe(tf)} className={`font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg ${timeframe === tf ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{tf.charAt(0).toUpperCase() + tf.slice(1)}</button>))}
                                </div>
                                <form onSubmit={handleFormSubmit} className="flex flex-col sm:flex-row gap-4">
                                    <input type="text" value={ticker} onChange={(e) => setTicker(e.target.value)} placeholder="Enter Stock Ticker (e.g., RELIANCE.NS)" className="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500"/>
                                    <button type="submit" disabled={loading} className="bg-green-600 hover:bg-green-700 disabled:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center">{loading ? 'Analyzing...' : 'Analyze'}</button>
                                </form>
                            </div>
                            
                            <div className="mt-8">
                                {error && <p className="text-red-400 text-center bg-red-500/10 p-4 rounded-lg">{error}</p>}
                                {initialLoad && !error && <div className="text-center p-8 bg-gray-800/30 rounded-lg"><div className="mx-auto text-gray-500">{icons.activity}</div><h3 className="mt-4 text-xl font-semibold text-gray-400">Welcome</h3><p className="text-gray-500">Enter a stock ticker to begin.</p></div>}
                                
                                {stockData && !loading && !error && (
                                <div className="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                                    <div className="lg:col-span-2 space-y-6">
                                        <RecommendationCard recommendation={stockData.recommendation} reason={stockData.reason} />
                                        <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
                                            <h3 className="text-xl font-bold mb-4 text-gray-200">Key Technical Metrics</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <Indicator icon={icons.trendingUp} label="Current Price" value={`₹${stockData.currentPrice.toFixed(2)}`} tooltipText="The latest trading price."/>
                                                <Indicator icon={icons.arrowsUpDown} label="52W High / Low" value={`₹${stockData.high52w.toFixed(2)} / ₹${stockData.low52w.toFixed(2)}`} tooltipText="The 52-week price range."/>
                                                <Indicator icon={icons.barChart2} label="RSI (14)" value={stockData.rsi.toFixed(2)} valueClassName={stockData.rsi > 55 ? 'text-green-400' : 'text-red-400'} tooltipText="Relative Strength Index. >55 is bullish."/>
                                                <Indicator icon={icons.zap} label="ADX (14)" value={stockData.adx.toFixed(2)} valueClassName={stockData.adx > 25 ? 'text-green-400' : 'text-red-400'} tooltipText="Average Directional Index. >25 indicates a strong trend."/>
                                                <Indicator icon={icons.shield} label="VStop" value={`₹${stockData.vstop.toFixed(2)}`} valueClassName={stockData.currentPrice > stockData.vstop ? 'text-green-400' : 'text-red-400'} tooltipText="Volatility Stop. Price above is bullish."/>
                                                <Indicator icon={icons.arrowUp} label="PSAR" value={stockData.psar ? `₹${stockData.psar.toFixed(2)}` : 'N/A'} valueClassName={stockData.psar && stockData.currentPrice > stockData.psar ? 'text-green-400' : 'text-red-400'} tooltipText="Parabolic SAR. Price above is bullish."/>
                                                <Indicator icon={icons.barChart2} label="Relative Strength" value={stockData.relativeStrength.toFixed(2)} valueClassName={stockData.relativeStrength > 0 ? 'text-green-400' : 'text-red-400'} tooltipText="Performance vs. NIFTY50."/>
                                                <Indicator icon={icons.barChart2} label="Chart Pattern" value={stockData.chartPattern} tooltipText="Identified technical chart pattern."/>
                                            </div>
                                        </div>
                                        {/* News card is now here */}
                                        <NewsAnalysisCard news={stockData.news} />
                                    </div>
                                    <div className="space-y-6">
                                        <MovingAveragesCard data={stockData} />
                                        <FundamentalsCard data={stockData} />
                                    </div>
                                </div>
                                )}
                            </div>
                        </main>
                        <footer className="text-center mt-12 text-gray-500 text-sm"><p>Disclaimer: This is not financial advice. All data is for informational purposes only.</p><p>Data provided by Yahoo Finance.</p></footer>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
